#!/usr/bin/env bash
version=0.4.0

tmpdir="${TMPDIR:-/tmp}/p3wm"
create_tmp_root() {
  mkdir -p "$tmpdir"
}

mktmp() {
  mktemp -p "$tmpdir" --suffix "$@"
}

find_resolve_tool() {
  if [[ -n $P3WM_RESOLVE_TOOL ]]; then
    return
  fi

  if has_bin kdiff3; then
    P3WM_RESOLVE_TOOL=builtin_resolve_kdiff3
  elif has_bin meld; then
    P3WM_RESOLVE_TOOL=builtin_resolve_meld
  elif has_bin vim; then
    P3WM_RESOLVE_TOOL=builtin_resolve_vim
  else
    echo No resolve tool available.
    echo "Please install vim / meld / kdiff3, or set a custom ‘\$P3WM_RESOLVE_TOOL’"
    echo "See p3wm(8) for details"
    exit 4
  fi
}

builtin_resolve_kdiff3() {
  kdiff3 --auto -o "$MERGED" "$BASE" "$LOCAL" "$REMOTE"
}

builtin_resolve_meld() {
  meld --auto-merge "$LOCAL" "$BASE" "$REMOTE" -o "$MERGED"
}

builtin_resolve_vim() {
  vim -f -d -c "4wincmd w | wincmd J" "$LOCAL" "$BASE" "$REMOTE" "$MERGED"
}

has_bin() {
  type -P "$1" >/dev/null
}

find_merge_tool() {
  if [[ -n $P3WM_MERGE_TOOL ]]; then
    return
  fi

  if has_bin git; then
    P3WM_MERGE_TOOL=builtin_merge_git
  elif has_bin merge; then
    P3WM_MERGE_TOOL=builtin_merge_merge
  else
    echo No merge tool available.
    echo "Please install git / rcs, or set a custom ‘\$P3WM_MERGE_TOOL’"
    echo "See p3wm(8) for details"
    exit 5
  fi
}

builtin_merge_git() {
  git merge-file -p "$@"
}

builtin_merge_merge() {
  merge -p "$@"
}


get_ver_tuple() {
  tac /var/log/pacman.log \
    | sed -Ene "/\\[ALPM\\] upgraded $1 / !d" \
      -e 's/.*\(([^ ]+) -> ([^)]+).*/\1 \2/p' -e q
}

get_pkg_arch() {
  pacman -Qi "$1" | awk '$1 == "Architecture" {print $3}'
}

resolve_tool() {
  local LOCAL="$1" BASE="$2" REMOTE="$3" MERGED="$4"
  eval "$P3WM_RESOLVE_TOOL"
}

ask_for_action() {
  printf "(V)iew diff, (D)elete .pacnew, (A)ccept merge, (R)un resolve tool, (Q)uit? "
}

main() {
  if [[ $P3WM_DEBUG = 1 ]]; then
    set -x
  fi

  set -e
  shopt -s nullglob

  create_tmp_root
  find_merge_tool
  find_resolve_tool

  if [[ ! -f $1 ]]; then
    cat <<EOF
p3wm(8) v$version

Usage: p3wm <pacnew file>

Example: ‘p3wm /etc/pacman.d/mirrorlist.pacnew’

See ‘man 8 p3wm’ for detailed usage and configuration.
EOF
    exit 1
  fi

  set -u

  bf_pacnew="$(realpath "$1")"
  bf_local="${bf_pacnew%.pacnew}"
  pkg_name="$(pacman -Qoq "$bf_local")"
  if [[ $bf_pacnew = "$bf_local" ]]; then
    echo 'You done messed up'
    exit 3
  fi

  ver_tuple="$(get_ver_tuple "$pkg_name")"
  oldver="${ver_tuple% *}"

  arch="$(get_pkg_arch "$pkg_name")"
  basename=$(basename "$bf_local")
  bf_base="$(mktmp ".base.$basename")"

  pkg_cached=""
  mapfile -t cache_dirs < <(pacman-conf | awk '$1 == "CacheDir" {print $3}')
  for cache_dir in "${cache_dirs[@]}"; do
    for f in "$cache_dir/$pkg_name-$oldver-$arch".pkg.* ; do
      pkg_cached="$f"
    done
  done

  if [[ -z $pkg_cached ]]; then
    echo "Unable to find package ‘$pkg_name-$oldver-$arch’ in cache"
    exit 2
  fi

  bf_id="${bf_local#/}"
  tar xOf "$pkg_cached" "$bf_id" -- > "$bf_base"
  bf_merged="$(mktmp ".merged.$basename")"

  if "$P3WM_MERGE_TOOL" "$bf_local" "$bf_base" "$bf_pacnew" > "$bf_merged"
  then
    echo M "$bf_local" "can be cleanly merged"
  else
    echo C "$bf_local" "cannot be cleanly merged"
  fi

  chmod --reference="$bf_local" "$bf_merged"

  while ask_for_action; read -r answer; do
    case "$answer" in
      q|Q)
        return 0
        ;;
      v|V)
        diff -u "$bf_local" "$bf_merged" ||:
        ;;
      d|D)
        rm -v "$bf_pacnew"
        return 0
        ;;
      a|A)
        mv -v "$bf_merged" "$bf_local"
        rm -v "$bf_pacnew"
        return 0
        ;;
      r|R)
        resolve_tool "$bf_local" "$bf_base" "$bf_pacnew" "$bf_merged" ||:
        ;;
      *)
        echo "Action not understood."
        ;;
    esac
  done
}

if [[ "$0" = "${BASH_SOURCE[0]}" ]]; then
  main "$@"
fi
